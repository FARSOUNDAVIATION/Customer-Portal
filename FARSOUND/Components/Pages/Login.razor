@page "/login"
@using System.ComponentModel.DataAnnotations
@using FARSOUND.Components.Shared
@using System.Security.Claims
@using FARSOUND.Data
@using FARSOUND.Components.Middleware
@using Microsoft.AspNetCore.Authentication.Cookies

@inject NavigationManager nav

<PageTitle>FARSOUND | Login</PageTitle>
<style>
    .button {
        border-radius: 8px;
    }
</style>
<div class="row" style="text-align: center;>
    <div class="col-md-4">
    <section>
    <br />
    <br />
    <h2 style="text-align:center; font-weight: bold;">User Area</h2>
    <br />
    <br />
    <h4>Log In</h4>
                <hr style="margin: auto; width: 50%;">
            <EditForm Model="Input" method="post" OnValidSubmit="OnLogin" FormName="Login">
                <DataAnnotationsValidator />
                <br />
                 <div class="form-floating mb-3"> 
                   <InputText @bind-Value="Input.Username" class="form-control" aria-required="true" /> 
                     <label for="username" class="form-label">Username</label> 
                    <ValidationMessage For="() => Input.Username" class="text-danger" /> 
                 </div> 

                <div class="form-floating mb-3">
                    <InputText @bind-Value="Input.Email" class="form-control" aria-required="true" />
                    <label for="email" class="form-label">Email</label>
                    <ValidationMessage For="() => Input.Email" class="text-danger" />
                </div>

                <div class="form-floating mb-3">
                    <InputText type="password" @bind-Value="Input.Password" class="form-control" aria-required="true" />
                    <label for="password" class="form-label">Password</label>
                    <ValidationMessage For="() => Input.Password" class="text-danger" />
                </div>
                <div>
                    <br />
                    <button class="button" type="submit" style="background-color: #FF4D00;" @onclick="OnLogin">Log In</button>
                    <br />
                    <br />
                    <a href="register">Don't have an account? Register here.</a>
                    <br />
                    <a href="userarea/accounts/forgotpassword">Forgotten your password?</a>
                </div>
                 <hr/>
            </EditForm>
        </section>
    </div>



@code {

    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    public async Task OnLogin()
    {
        var user = AppDBContext.Verify(Input.Email, Input.Password);
        // var user = AppDBContext.Verify(Input.Username, Input.Email, Input.Password);
        if (user is null)
        {
            //alert
            return;
        }
        var claims = new List<Claim>
    {
    new Claim(ClaimTypes.Name, user.Username),
    new Claim(ClaimTypes.Email, user.Email),
    new Claim(ClaimTypes.Role, user.Role),
    };
        var claimIdentity = new ClaimsIdentity(claims, CookieAuthenticationDefaults.AuthenticationScheme);
        ClaimsPrincipal claimsPrincipal = new ClaimsPrincipal(claimIdentity);
        Guid key = Guid.NewGuid();
        AuthMiddleware.Logins[key] = claimsPrincipal;
        // nav.NavigateTo("/loginlandingpage", true);
        nav.NavigateTo($"/login?key={key}", true);

    }

    private sealed class InputModel
    {

        [Required]
        [DataType(DataType.Text)]
        public string Username { get; set; } = "";

        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";


        [DataType(DataType.Password)]
        public string Password { get; set; } = "";
    }

}
